<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% if session['tname'] == 'operation' or session['tname'] == 'project' and session['type'] == 'manager' %}
{% extends 'sidebar.html' %}
{% elif session['email'] == 'admin@gmail.com' %}
{% extends '/admin/sidebar.html' %}
{% block content %}
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h5 class=" mb-0 text-black">Internal Lab Dashboard</h5>
        <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i
                class="fas fa-download fa-sm text-white-50"></i> Generate Report</a>
    </div>
    <!-- Your content for 'operation' session -->
</div>
<div class="container-fluid">
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Lab List
        </div>
        <div class="card-body">
            <div class="container">
                
                <table class="table table-bordered  table-class" id="datatablesSimple">
                    <thead class="thead-dark">
                        <tr>
                            <th>Name</th>
                            <th> Ticket Number </th>
                            <th>Purpose</th>
                            <th>Material</th>
                            <th>Qty</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket, rows in grouped_data.items() %}
                        {% for row in rows %}

                        <tr>
                            <td> <a href="#" class="open-modal" data-id="{{ row[0] }}"
                                    style="text-decoration: none;color: black">{{ row[1] }}</a>
                            </td>
                            {% if loop.first %}
                            <td rowspan="{{ rows|length }}">
                                {{ row[12] }}
                            </td>
                            {% endif %}
                            <td>{{ row[2] }}</td>
                            <td>{{ row[3] }}</td>
                            <td>{{ row[4] }}</td>
                            <td>{{ row[5] }}</td>
                            <td>{{ row[6] }}</td>
                            {% if loop.first %}
                            <td rowspan="{{ rows|length }}">
                                {% if session['tname'] == 'operation' %}
                                {% if row[7] == 'returned approved' %}
                                <a href="#" class="btn btn-secondary btn-sm">Returned</a>
                                {% elif row[7] == 'approved' %}
                                <a href="#" class="btn btn-primary btn-sm">Approved</a>
                                {% elif row[7] == 'return initiated' %}
                                <a href="/elabapproveadd?tno={{ row[12] }}" class="btn btn-danger btn-sm">Approve</a>
                                {% elif row[7] == 'approved by manager' %}
                                <form action="/laddserial" method="POST">
                                    <input type="hidden" name="tno" value="{{ row[12] }}">

                                    <input type="submit" name="submit" value="approve" class="btn btn-danger btn-sm">
                                </form>
                                {% else %}
                                <a href="#" class="btn btn-primary btn-sm">Pending</a>
                                {% endif %}
                                {% elif session['email'] == 'admin@gmail.com' or session['tname'] == 'project' and
                                session['type'] == 'manager' %}
                                {% if row[7] == 'Pending with manager' %}
                                <a href="/milabapprove?tno={{ row[12] }}" class="btn btn-danger btn-sm">Approve</a>
                                <button type="button" class="btn btn-warning btn-sm" data-rid="{{ row[12] }}"
                                    id="rejectBtn">Reject</button>
                                {% elif row[7] == 'rejected by manager' %}
                                <a href="#" class="btn btn-warning btn-sm">Rejected</a>
                                {% else %}
                                <a href="#" class="btn btn-primary btn-sm">Approved</a>
                                {% endif %}
                                {% else %}
                                <p> Check with developer </p>
                                {% endif %}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
                <div class="modal" id="myModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <!-- Modal Header -->
                            <div class="modal-header">
                                <h4 class="modal-title">Additional Details</h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>

                            <!-- Modal Body -->
                            <div class="modal-body">
                                <!-- Display details here -->
                                <div id="modal-details">
                                </div>
                            </div>

                            <!-- Modal Footer -->
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class='pagination-container'>
                    <nav>
                        <ul class="pagination">
                            <!-- Here the JS Function Will Add the Rows -->
                        </ul>
                    </nav>
                </div>
                <div class="rows_count">Showing 11 to 20 of 91 entries</div>

            </div> <!--             End of Container -->
        </div>
    </div>

    <div id="serialNumberModal" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enter Serial Number</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="serialNumberForm" method="POST">
                        <div class="form-group">
                            <label for="serialNumberInput">Serial Number:</label>
                            <input type="text" class="form-control" id="serialNumberInput" name="serialNumber">
                        </div>
                        <input type="hidden" id="labId" name="id">
                        <input type="hidden" id="labStatus" name="status">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="submitSerialNumber">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <div id="rejectModal" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enter Reason</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="/labureject" method="POST">
                        <div class="form-group">
                            <label for="ReasonInput">Reason:</label>
                            <input type="text" class="form-control" id="ReasonInput" name="reason">
                        </div>
                        <input type="hidden" id="rid" name="rid">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="submitReason">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            $(".open-modal").click(function () {
                var id = $(this).data('id');

                // Fetch details via AJAX request
                $.ajax({
                    url: '/lapprove',
                    method: 'GET',
                    data: { id: id },
                    success: function (response) {
                        // Check if response contains data
                        if (response) {
                            // Populate modal body with details
                            $("#modal-details").html(
                                "<p>Ticket No: " + response.ticket_no + "</p>" +
                                "<p> Name: " + response.name + "</p>" +
                                "<p>Material: " + response.material + "</p>" +
                                "<p>Part Number: " + response.Part_Number + "</p>" +
                                "<p>Status: " + response.status + "</p>" +
                                "<p>Serial Number: " + response.serial_number + "</p>"
                            );
                        } else {
                            // If response is empty or does not contain data
                            $("#modal-details").text("No data available");
                        }

                        // Open the modal
                        $("#myModal").modal('show');
                    },
                    error: function (xhr, status, error) {
                        // Handle error
                        console.error(error);
                        // Update modal title and body in case of error
                        $(".modal-title").text('Error');
                        $("#modal-details").html('<p>An error occurred while fetching the details.</p>');

                        // Open the modal
                        $("#myModal").modal('show');
                    }
                });
            });
            $(".modal-footer .btn-danger").click(function () {
                $("#myModal").modal('hide');
            });
            $(".close").click(function () {
                $("#myModal").modal('hide');
            });

        });
    </script>


    <script>
        $(document).ready(function () {
            $(document).on('click', '.approveBtn', function () {
                var id = $(this).data('id');
                var status = $(this).data('status');
                $('#labId').val(id);
                $('#labStatus').val(status);
                $('#serialNumberModal').modal('show');
            });
            $(document).on('click', '#rejectBtn', function () {
                var rid = $(this).data('rid');
                $('#rid').val(rid);
                $('#rejectModal').modal('show');
            });

            $('#submitSerialNumber').click(function () {
                var serialNumber = $('#serialNumberInput').val();
                var id = $('#labId').val();
                var status = $('#labStatus').val();

                $.post('/labapprove', { serialNumber: serialNumber, id: id, status: status }, function (data) {
                    console.log("Response from server:", data);
                    window.location.href = '/lapprove';
                    $('#serialNumberModal').modal('hide');
                });

            });
            $('#submitReason').click(function (event) {
                event.preventDefault();
                var id = $('#rid').val();
                var reason = $('#ReasonInput').val();

                $.post('/labureject', { id: id, reason: reason }, function (data) {
                    console.log("Response from server:", data);
                    if (data.success) {
                        window.location.href = '/lapprove';
                    } else {
                        console.error("Error in submission");
                    }
                    $('#rejectModal').modal('hide');
                });
            });

            // Handle modal close
            $('.modal-footer .btn-secondary, .modal-header .close').click(function () {
                $(this).closest('.modal').modal('hide');
            });
        });

    </script>
    {% endblock %}

    {% else %}
    <script>
        window.onload = function () {
            Swal.fire({
                title: 'Access Denied!',
                text: 'You are not allowed to view this page.',
                icon: 'warning',
                timer: 5000,
                timerProgressBar: true,
                showConfirmButton: false
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.timer) {
                    window.location.href = "/logout";
                }
            });
        };
    </script>

    {% endif %}