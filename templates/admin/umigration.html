<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% extends 'admin/sidebar.html' %}

{% block content %}
<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h6 class="mb-0 text-black">MIGRATION DASHBOARD</h6>
        <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i
                class="fas fa-download fa-sm text-white-50"></i> Generate Report</a>
    </div>

    <!-- Content Row -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="row">
                <div class="col-lg-12">
                    <i class="fas fa-table me-1"></i>
                    Manage User
                </div>
            </div>
        </div>
        <div class="card-body">
            <table id="datatablesSimple">
                <thead>
                    <tr>
                        <th>User Name</th>
                        <th>User Type</th>
                        <th>Team Name</th>
                        <th>Email</th>
                        <th>Action</th>           
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>User Name</th>
                        <th>User Type</th>
                        <th>Team Name</th>    
                        <th>Email</th>
                        <th>Action</th>               
                    </tr>
                </tfoot>
                <tbody>
                    {% for row in data %}
                    <tr>
                        <td>{{ row[1] }}</td>
                        <td>{{ row[3] }}</td>
                        <td>{{ row[4] }}</td>
                        <td>{{ row[7] }}</td>
                        <td>
                            <form class="migration-form" action="umigration?id={{ row[0] }}" method="POST">
                                <select class="form-control" name="priority">
                                    <option value="">Select</option>
                                    <option value="hr">HR</option>
                                    <option value="finance">Finance</option>
                                    <option value="noc">NOC</option>
                                    <option value="operation">Operation</option>
                                    <option value="project">Project</option>
                                </select>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $(".migration-form select").change(function () {
            var form = $(this).closest("form");
            var originalTeam = $(this).closest("tr").find("td:eq(2)").text(); // Assuming team name is in the 3rd column
            var newTeam = $(this).val();

            if (newTeam === "") {
                return; // No action if no team is selected
            }

            // Submit the form via AJAX
            $.ajax({
                url: form.attr("action"),
                method: form.attr("method"),
                data: form.serialize(),
                success: function (response) {
                    // Assuming the server returns `originalTeam` and `newTeam` in response
                    Swal.fire({
                        title: 'Success!',
                        text: 'User has been migrated from ' + originalTeam + ' to ' + newTeam + '.',
                        icon: 'success',
                        timer: 3000, // Auto-close after 3 seconds
                        showConfirmButton: false
                    }).then(() => {
                        // Optionally reload the page or update the table
                        location.reload();
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Error!',
                        text: 'There was an issue migrating the user. Please try again.',
                        icon: 'error',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
            });

            return false; // Prevent default form submission
        });
    });
</script>
{% endblock %}
